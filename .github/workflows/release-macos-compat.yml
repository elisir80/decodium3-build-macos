name: Release macOS (Tahoe + Sequoia + Intel Sequoia/Monterey)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. v1.3.5)"
        required: true
        default: "v1.3.5"
      publish_release:
        description: "Publish GitHub release"
        required: true
        default: false
        type: boolean
  push:
    branches: [master]
    paths:
      - ".github/workflows/release-macos-compat.yml"
      - "scripts/release-macos.sh"
      - "CMakeLists.txt"
      - "bundle_fixup/CMakeLists.txt"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.asset_suffix }} on ${{ matrix.runner }}
    runs-on: ${{ matrix.runner }}
    continue-on-error: ${{ matrix.experimental }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          # Keep ARM build target for Sequoia (15.x) and Tahoe.
          - runner: macos-26
            arch_label: arm64
            compat_macos: "26.0"
            asset_suffix: "macos-tahoe-arm64"
            experimental: false
          - runner: macos-15
            arch_label: arm64
            compat_macos: "15.0"
            asset_suffix: "macos-sequoia-arm64"
            experimental: false
          # Intel build runs on GitHub's x86_64 image.
          - runner: macos-15-intel
            arch_label: x86_64
            compat_macos: "15.0"
            asset_suffix: "macos-sequoia-x86_64"
            experimental: false
          # Best-effort legacy Intel target for older Macs (Monterey line).
          - runner: macos-15-intel
            arch_label: x86_64
            compat_macos: "12.0"
            asset_suffix: "macos-monterey-x86_64"
            experimental: true
    env:
      HOMEBREW_NO_AUTO_UPDATE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select version
        run: |
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v0.0.0-ci-${GITHUB_SHA::7}"
          fi
          if [[ "$VERSION" != v* ]]; then
            VERSION="v${VERSION}"
          fi
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Using version: ${VERSION}"

      - name: Install dependencies
        run: |
          brew install qt@5 gcc fftw hamlib libusb boost pkg-config

          GCC_PREFIX="$(brew --prefix gcc)"
          GFORTRAN="$(ls "${GCC_PREFIX}"/bin/gfortran-* 2>/dev/null | head -1 || true)"
          if [[ -z "${GFORTRAN}" ]]; then
            echo "gfortran not found under ${GCC_PREFIX}/bin"
            exit 1
          fi
          echo "FC=${GFORTRAN}" >> "$GITHUB_ENV"
          "${GFORTRAN}" --version

          QT5_PREFIX="$(brew --prefix qt@5)"
          echo "${QT5_PREFIX}/bin" >> "$GITHUB_PATH"
          echo "CMAKE_PREFIX_PATH=${QT5_PREFIX}" >> "$GITHUB_ENV"

      - name: Build release assets
        run: |
          EXTRA_ARGS=()
          if [[ "${{ matrix.experimental }}" == "true" ]]; then
            echo "Experimental legacy build enabled for ${{ matrix.asset_suffix }}; skipping strict compatibility gate."
            EXTRA_ARGS+=(--skip-compat-check)
          fi
          scripts/release-macos.sh "${VERSION}" \
            --compat-macos "${{ matrix.compat_macos }}" \
            --asset-suffix "${{ matrix.asset_suffix }}" \
            --repo "${GITHUB_REPOSITORY}" \
            "${EXTRA_ARGS[@]}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: decodium3-ft2-${{ env.VERSION }}-${{ matrix.asset_suffix }}
          if-no-files-found: error
          path: |
            build/decodium3-ft2-${{ env.VERSION }}-${{ matrix.asset_suffix }}.dmg
            build/decodium3-ft2-${{ env.VERSION }}-${{ matrix.asset_suffix }}.zip
            build/decodium3-ft2-${{ env.VERSION }}-${{ matrix.asset_suffix }}-sha256.txt

  publish:
    name: Publish GitHub release
    needs: [build]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Select version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ "$VERSION" != v* ]]; then
            VERSION="v${VERSION}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Using version: ${VERSION}"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: decodium3-ft2-${{ steps.version.outputs.version }}-macos-*
          merge-multiple: true
          path: release-assets

      - name: Validate assets
        run: |
          ls -lh release-assets
          VERSION="${{ steps.version.outputs.version }}"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64.dmg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64.zip"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64-sha256.txt"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64.dmg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64.zip"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64-sha256.txt"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64.dmg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64.zip"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64-sha256.txt"
          if [[ -f "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64.dmg" && \
                -f "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64.zip" && \
                -f "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64-sha256.txt" ]]; then
            echo "Monterey Intel artifact detected and will be published."
          else
            echo "Monterey Intel artifact not produced in this run (experimental target)."
          fi

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${GITHUB_REPOSITORY}"

          NOTES_FILE="$(mktemp)"
          {
            echo "# Decodium 3 FT2 ${VERSION} (macOS + Linux AppImage)"
            echo
            echo "## English (UK)"
            echo "This release includes:"
            echo "- TCI binary frame parser hardening with strict header/payload bounds checks."
            echo "- TCI pseudo-sync wait refactor: nested QEventLoop::exec() loops removed in mysleep1..8."
            echo "- Protected foxcom_.wave snapshots across UI/audio threads to reduce TX race risk."
            echo "- TCI C++/Fortran boundary hardening (kin clamps + bounded writes)."
            echo "- macOS audio resilience updates (Sequoia-safe stop path + improved underrun handling)."
            echo "- TOTP now aligned to NTP-corrected time source."
            echo "- QRegExp migration to QRegularExpression in critical runtime/network paths."
            echo "- macOS shared-memory mmap flow retained (no .pkg required)."
            echo "- Apple Silicon build for macOS Tahoe."
            echo "- Apple Silicon build for macOS Sequoia."
            echo "- Apple Intel build for macOS Sequoia."
            echo "- Apple Intel build for macOS Monterey (best effort/experimental when generated)."
            echo "- Linux x86_64 AppImage build (published by Linux release workflow)."
            echo
            echo "Linux minimum requirements:"
            echo "- x86_64 CPU, 4 GB RAM minimum"
            echo "- glibc >= 2.35"
            echo "- libfuse2/FUSE2 + ALSA/PulseAudio/PipeWire"
            echo
            echo "If the app does not start on macOS, run from Terminal:"
            echo "\`sudo xattr -r -d com.apple.quarantine /Applications/ft2.app\`"
            echo
            echo "Refer to \`CHANGELOG.md\` for full details."
            echo
            echo "## Italiano"
            echo "Questa release include:"
            echo "- Hardening parser frame binari TCI con controlli rigorosi header/payload."
            echo "- Refactor attese pseudo-sync TCI: rimossi loop annidati QEventLoop::exec() in mysleep1..8."
            echo "- Snapshot protetti di foxcom_.wave tra thread UI/audio per ridurre rischio race TX."
            echo "- Hardening boundary TCI C++/Fortran (clamp kin + scritture limitate)."
            echo "- Aggiornamenti resilienza audio macOS (stop path Sequoia-safe + gestione underrun migliorata)."
            echo "- TOTP ora allineato al tempo corretto NTP."
            echo "- Migrazione QRegExp a QRegularExpression nei percorsi runtime/network critici."
            echo "- Flusso shared-memory macOS su mmap confermato (nessun .pkg richiesto)."
            echo "- Build Apple Silicon per macOS Tahoe."
            echo "- Build Apple Silicon per macOS Sequoia."
            echo "- Build Apple Intel per macOS Sequoia."
            echo "- Build Apple Intel per macOS Monterey (best effort/sperimentale quando generata)."
            echo "- Build Linux x86_64 AppImage (pubblicata dal workflow Linux release)."
            echo
            echo "Requisiti minimi Linux:"
            echo "- CPU x86_64, minimo 4 GB RAM"
            echo "- glibc >= 2.35"
            echo "- libfuse2/FUSE2 + ALSA/PulseAudio/PipeWire"
            echo
            echo "Se l'app non si avvia su macOS, esegui da Terminale:"
            echo "\`sudo xattr -r -d com.apple.quarantine /Applications/ft2.app\`"
            echo
            echo "Per i dettagli completi, vedi \`CHANGELOG.md\`."
          } > "${NOTES_FILE}"

          ASSETS=(
            "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64.dmg"
            "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64.zip"
            "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64-sha256.txt"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64.dmg"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64.zip"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64-sha256.txt"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64.dmg"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64.zip"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64-sha256.txt"
          )
          if [[ -f "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64.dmg" && \
                -f "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64.zip" && \
                -f "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64-sha256.txt" ]]; then
            ASSETS+=(
              "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64.dmg"
              "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64.zip"
              "release-assets/decodium3-ft2-${VERSION}-macos-monterey-x86_64-sha256.txt"
            )
          fi

          if gh release view "${VERSION}" --repo "${REPO}" >/dev/null 2>&1; then
            gh release upload "${VERSION}" "${ASSETS[@]}" --repo "${REPO}" --clobber
            gh release edit "${VERSION}" --repo "${REPO}" --notes-file "${NOTES_FILE}"
          else
            gh release create "${VERSION}" "${ASSETS[@]}" \
              --repo "${REPO}" \
              --title "Decodium 3 FT2 ${VERSION} (macOS + Linux AppImage)" \
              --notes-file "${NOTES_FILE}"
          fi

          rm -f "${NOTES_FILE}"
