name: Release macOS (Tahoe + Sequoia + Intel Sequoia)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. v1.3.0)"
        required: true
        default: "v1.3.0"
      publish_release:
        description: "Publish GitHub release"
        required: true
        default: false
        type: boolean
  push:
    branches: [master]
    paths:
      - ".github/workflows/release-macos-compat.yml"
      - "scripts/release-macos.sh"
      - "CMakeLists.txt"
      - "bundle_fixup/CMakeLists.txt"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.asset_suffix }} on ${{ matrix.runner }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          # Keep ARM build target for Sequoia (15.x) and Tahoe.
          - runner: macos-26
            arch_label: arm64
            compat_macos: "26.0"
            asset_suffix: "macos-tahoe-arm64"
          - runner: macos-15
            arch_label: arm64
            compat_macos: "15.0"
            asset_suffix: "macos-sequoia-arm64"
          # Intel build runs on GitHub's x86_64 image.
          - runner: macos-15-intel
            arch_label: x86_64
            compat_macos: "15.0"
            asset_suffix: "macos-sequoia-x86_64"
    env:
      HOMEBREW_NO_AUTO_UPDATE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select version
        run: |
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v0.0.0-ci-${GITHUB_SHA::7}"
          fi
          if [[ "$VERSION" != v* ]]; then
            VERSION="v${VERSION}"
          fi
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Using version: ${VERSION}"

      - name: Install dependencies
        run: |
          brew install qt@5 gcc fftw hamlib libusb boost pkg-config

          GCC_PREFIX="$(brew --prefix gcc)"
          GFORTRAN="$(ls "${GCC_PREFIX}"/bin/gfortran-* 2>/dev/null | head -1 || true)"
          if [[ -z "${GFORTRAN}" ]]; then
            echo "gfortran not found under ${GCC_PREFIX}/bin"
            exit 1
          fi
          echo "FC=${GFORTRAN}" >> "$GITHUB_ENV"
          "${GFORTRAN}" --version

          QT5_PREFIX="$(brew --prefix qt@5)"
          echo "${QT5_PREFIX}/bin" >> "$GITHUB_PATH"
          echo "CMAKE_PREFIX_PATH=${QT5_PREFIX}" >> "$GITHUB_ENV"

      - name: Build release assets
        run: |
          scripts/release-macos.sh "${VERSION}" \
            --compat-macos "${{ matrix.compat_macos }}" \
            --asset-suffix "${{ matrix.asset_suffix }}" \
            --repo "${GITHUB_REPOSITORY}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: decodium3-ft2-${{ env.VERSION }}-${{ matrix.asset_suffix }}
          if-no-files-found: error
          path: |
            build/decodium3-ft2-${{ env.VERSION }}-${{ matrix.asset_suffix }}.dmg
            build/decodium3-ft2-${{ env.VERSION }}-${{ matrix.asset_suffix }}.zip
            build/decodium3-ft2-${{ env.VERSION }}-${{ matrix.asset_suffix }}-sha256.txt

  publish:
    name: Publish GitHub release
    needs: [build]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Select version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ "$VERSION" != v* ]]; then
            VERSION="v${VERSION}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Using version: ${VERSION}"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: decodium3-ft2-${{ steps.version.outputs.version }}-macos-*
          merge-multiple: true
          path: release-assets

      - name: Validate assets
        run: |
          ls -lh release-assets
          VERSION="${{ steps.version.outputs.version }}"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64.dmg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64.zip"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64-sha256.txt"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64.dmg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64.zip"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64-sha256.txt"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64.dmg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64.zip"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64-sha256.txt"

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${GITHUB_REPOSITORY}"

          NOTES_FILE="$(mktemp)"
          {
            echo "# Decodium 3 FT2 ${VERSION} (macOS)"
            echo
            echo "## English (UK)"
            echo "This release includes:"
            echo "- Audio output auto-rebind recovery on runtime failures."
            echo "- Improved output-device resilience for underruns."
            echo "- UDP/network interface reliability improvements."
            echo "- NTP protocol hardening and improved fallback handling."
            echo "- NTP status bar improvements with last-sync age."
            echo "- DT timing improvements for remote stations with configurable clamp limits in Settings -> Advanced."
            echo "- Apple Silicon build for macOS Tahoe."
            echo "- Apple Silicon build for macOS Sequoia."
            echo "- Apple Intel build for macOS Sequoia."
            echo
            echo "If the app does not start on macOS, run from Terminal:"
            echo "\`sudo xattr -r -d com.apple.quarantine /Applications/ft2.app\`"
            echo
            echo "Refer to \`CHANGELOG.md\` for full details."
            echo
            echo "## Italiano"
            echo "Questa release include:"
            echo "- Recupero automatico auto-rebind dell'uscita audio su errori runtime."
            echo "- Maggiore robustezza delle periferiche audio in uscita sugli underrun."
            echo "- Miglioramenti affidabilita' UDP/interfacce di rete."
            echo "- NTP piu' robusto e fallback migliorato."
            echo "- Miglioramenti barra stato NTP con eta' ultima sincronizzazione."
            echo "- Miglioramenti timing DT per stazioni remote con limiti configurabili in Impostazioni -> Avanzate."
            echo "- Build Apple Silicon per macOS Tahoe."
            echo "- Build Apple Silicon per macOS Sequoia."
            echo "- Build Apple Intel per macOS Sequoia."
            echo
            echo "Se l'app non si avvia su macOS, esegui da Terminale:"
            echo "\`sudo xattr -r -d com.apple.quarantine /Applications/ft2.app\`"
            echo
            echo "Per i dettagli completi, vedi \`CHANGELOG.md\`."
          } > "${NOTES_FILE}"

          ASSETS=(
            "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64.dmg"
            "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64.zip"
            "release-assets/decodium3-ft2-${VERSION}-macos-tahoe-arm64-sha256.txt"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64.dmg"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64.zip"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-arm64-sha256.txt"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64.dmg"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64.zip"
            "release-assets/decodium3-ft2-${VERSION}-macos-sequoia-x86_64-sha256.txt"
          )

          if gh release view "${VERSION}" --repo "${REPO}" >/dev/null 2>&1; then
            gh release upload "${VERSION}" "${ASSETS[@]}" --repo "${REPO}" --clobber
            gh release edit "${VERSION}" --repo "${REPO}" --notes-file "${NOTES_FILE}"
          else
            gh release create "${VERSION}" "${ASSETS[@]}" \
              --repo "${REPO}" \
              --title "Decodium 3 FT2 ${VERSION} (macOS arm64 + x86_64)" \
              --notes-file "${NOTES_FILE}"
          fi

          rm -f "${NOTES_FILE}"
