name: Release macOS (Sequoia+Tahoe+Intel)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. v1.0.9)"
        required: true
        default: "v1.0.9"
      publish_release:
        description: "Publish GitHub release"
        required: true
        default: false
        type: boolean
  push:
    branches: [master]
    paths:
      - ".github/workflows/release-macos-compat.yml"
      - "scripts/release-macos.sh"
      - "CMakeLists.txt"
      - "bundle_fixup/CMakeLists.txt"
      - "Darwin/ft2-pkg-postinstall.sh"
      - "Darwin/com.ft2.jtdx.sysctl.plist"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.arch_label }} on ${{ matrix.runner }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          # Keep ARM build target for Sequoia (15.x) and Tahoe.
          - runner: macos-15
            arch_label: arm64
            compat_macos: "15.0"
          # Intel build runs on GitHub's x86_64 image.
          - runner: macos-15-intel
            arch_label: x86_64
            compat_macos: "15.0"
    env:
      HOMEBREW_NO_AUTO_UPDATE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select version
        run: |
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v0.0.0-ci-${GITHUB_SHA::7}"
          fi
          if [[ "$VERSION" != v* ]]; then
            VERSION="v${VERSION}"
          fi
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Using version: ${VERSION}"

      - name: Install dependencies
        run: |
          brew install qt@5 gcc fftw hamlib libusb boost pkg-config

          GCC_PREFIX="$(brew --prefix gcc)"
          GFORTRAN="$(ls "${GCC_PREFIX}"/bin/gfortran-* 2>/dev/null | head -1 || true)"
          if [[ -n "${GFORTRAN}" ]]; then
            sudo ln -sf "${GFORTRAN}" /usr/local/bin/gfortran
          fi
          gfortran --version

          QT5_PREFIX="$(brew --prefix qt@5)"
          echo "${QT5_PREFIX}/bin" >> "$GITHUB_PATH"
          echo "CMAKE_PREFIX_PATH=${QT5_PREFIX}" >> "$GITHUB_ENV"

      - name: Build release assets
        run: |
          scripts/release-macos.sh "${VERSION}" \
            --compat-macos "${{ matrix.compat_macos }}" \
            --repo "${GITHUB_REPOSITORY}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: decodium3-ft2-${{ env.VERSION }}-macos-${{ matrix.arch_label }}
          if-no-files-found: error
          path: |
            build/decodium3-ft2-${{ env.VERSION }}-macos-${{ matrix.arch_label }}.dmg
            build/decodium3-ft2-${{ env.VERSION }}-macos-${{ matrix.arch_label }}.zip
            build/decodium3-ft2-${{ env.VERSION }}-macos-${{ matrix.arch_label }}.pkg
            build/decodium3-ft2-${{ env.VERSION }}-macos-${{ matrix.arch_label }}-sha256.txt

  publish:
    name: Publish GitHub release
    needs: [build]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Select version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ "$VERSION" != v* ]]; then
            VERSION="v${VERSION}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Using version: ${VERSION}"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: decodium3-ft2-${{ steps.version.outputs.version }}-macos-*
          merge-multiple: true
          path: release-assets

      - name: Validate assets
        run: |
          ls -lh release-assets
          VERSION="${{ steps.version.outputs.version }}"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-arm64.dmg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-arm64.zip"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-arm64.pkg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-arm64-sha256.txt"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-x86_64.dmg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-x86_64.zip"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-x86_64.pkg"
          test -f "release-assets/decodium3-ft2-${VERSION}-macos-x86_64-sha256.txt"

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${GITHUB_REPOSITORY}"

          NOTES_FILE="$(mktemp)"
          {
            echo "# Decodium 3 FT2 ${VERSION} (macOS)"
            echo
            echo "## English (UK)"
            echo "Release including two architectures:"
            echo "- Apple Silicon (arm64): compatible with macOS Sequoia and Tahoe"
            echo "- Intel (x86_64): built on GitHub macOS Intel runner"
            echo
            echo "Refer to \`CHANGELOG.md\` for full details."
            echo
            echo "## Italiano"
            echo "Release con due architetture:"
            echo "- Apple Silicon (arm64): compatibile con macOS Sequoia e Tahoe"
            echo "- Intel (x86_64): compilata su runner macOS Intel di GitHub"
            echo
            echo "Per i dettagli completi, vedi \`CHANGELOG.md\`."
          } > "${NOTES_FILE}"

          ASSETS=(
            "release-assets/decodium3-ft2-${VERSION}-macos-arm64.dmg"
            "release-assets/decodium3-ft2-${VERSION}-macos-arm64.zip"
            "release-assets/decodium3-ft2-${VERSION}-macos-arm64.pkg"
            "release-assets/decodium3-ft2-${VERSION}-macos-arm64-sha256.txt"
            "release-assets/decodium3-ft2-${VERSION}-macos-x86_64.dmg"
            "release-assets/decodium3-ft2-${VERSION}-macos-x86_64.zip"
            "release-assets/decodium3-ft2-${VERSION}-macos-x86_64.pkg"
            "release-assets/decodium3-ft2-${VERSION}-macos-x86_64-sha256.txt"
          )

          if gh release view "${VERSION}" --repo "${REPO}" >/dev/null 2>&1; then
            gh release upload "${VERSION}" "${ASSETS[@]}" --repo "${REPO}" --clobber
            gh release edit "${VERSION}" --repo "${REPO}" --notes-file "${NOTES_FILE}"
          else
            gh release create "${VERSION}" "${ASSETS[@]}" \
              --repo "${REPO}" \
              --title "Decodium 3 FT2 ${VERSION} (macOS arm64 + x86_64)" \
              --notes-file "${NOTES_FILE}"
          fi

          rm -f "${NOTES_FILE}"
