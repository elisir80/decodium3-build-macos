name: Release Linux AppImage

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. v1.3.3)"
        required: true
        default: "v1.3.3"
      publish_release:
        description: "Upload AppImage to GitHub release"
        required: true
        default: true
        type: boolean
  push:
    branches: [master]
    paths:
      - ".github/workflows/release-linux-appimage.yml"
      - ".github/workflows/build-linux.yml"
      - "CMakeLists.txt"

permissions:
  contents: write

jobs:
  build:
    name: Build Linux AppImage
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select version
        run: |
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v0.0.0-ci-${GITHUB_SHA::7}"
          fi
          if [[ "$VERSION" != v* ]]; then
            VERSION="v${VERSION}"
          fi
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Using version: ${VERSION}"

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            build-essential \
            gfortran \
            cmake \
            pkg-config \
            qtbase5-dev \
            qtmultimedia5-dev \
            libqt5multimedia5-plugins \
            libqt5serialport5-dev \
            libqt5websockets5-dev \
            libqt5svg5-dev \
            libqt5sql5-sqlite \
            qttools5-dev \
            qttools5-dev-tools \
            libfftw3-dev \
            libhamlib-dev \
            libhamlib-utils \
            libusb-1.0-0-dev \
            libudev-dev \
            libboost-log-dev \
            libboost-filesystem-dev \
            libboost-thread-dev \
            portaudio19-dev \
            libreadline-dev \
            desktop-file-utils \
            patchelf \
            wget \
            file \
            libfuse2 \
            texinfo

      - name: Configure CMake
        run: |
          cmake -B build-appimage -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DFORK_RELEASE_VERSION="${VERSION}" \
            -DWSJT_GENERATE_DOCS=OFF \
            -DWSJT_SKIP_MANPAGES=ON \
            -DWSJT_BUILD_UTILS=OFF

      - name: Build Fortran library
        run: make -C build-appimage -j1 wsjt_fort_omp

      - name: Build applications
        run: make -C build-appimage -j"$(nproc)" wsjtx jt9 wsprd message_aggregator

      - name: Assemble AppDir
        run: |
          APPDIR="${PWD}/AppDir"
          rm -rf "${APPDIR}"
          mkdir -p "${APPDIR}/usr/bin"
          mkdir -p "${APPDIR}/usr/share/applications"
          mkdir -p "${APPDIR}/usr/share/icons/hicolor/256x256/apps"
          mkdir -p "${APPDIR}/usr/share/wsjtx"

          cp build-appimage/ft2 build-appimage/jt9 build-appimage/wsprd build-appimage/message_aggregator "${APPDIR}/usr/bin/"
          cp cty.dat "${APPDIR}/usr/share/wsjtx/" 2>/dev/null || true
          cp -r sounds "${APPDIR}/usr/share/wsjtx/" 2>/dev/null || true
          cp -r Palettes "${APPDIR}/usr/share/wsjtx/" 2>/dev/null || true
          cp icons/Unix/wsjtx_icon.png "${APPDIR}/usr/share/icons/hicolor/256x256/apps/ft2.png"

          cat > "${APPDIR}/usr/share/applications/ft2.desktop" <<'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=Decodium FT2
          Comment=Amateur Radio Weak Signal Operating
          Exec=ft2
          Icon=ft2
          Terminal=false
          Categories=AudioVideo;Audio;HamRadio;
          StartupNotify=true
          DESKTOP

          cat > "${APPDIR}/AppRun" <<'APPRUN'
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "$0")")"
          export PATH="${HERE}/usr/bin:${PATH}"
          export WSJTX_DATA_DIR="${HERE}/usr/share/wsjtx"
          exec "${HERE}/usr/bin/ft2" "$@"
          APPRUN
          chmod +x "${APPDIR}/AppRun"

      - name: Build AppImage
        run: |
          export APPIMAGE_EXTRACT_AND_RUN=1
          export QMAKE=/usr/lib/qt5/bin/qmake
          export ARCH=x86_64

          # linuxdeploy-plugin-qt expects this directory on some Ubuntu images.
          # When missing, the plugin aborts with std::filesystem_error.
          sudo mkdir -p /usr/lib/x86_64-linux-gnu/qt5/plugins/mediaservice

          mkdir -p tools
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage -O tools/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage -O tools/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x tools/linuxdeploy-x86_64.AppImage tools/linuxdeploy-plugin-qt-x86_64.AppImage
          sudo install -m 0755 tools/linuxdeploy-plugin-qt-x86_64.AppImage /usr/local/bin/linuxdeploy-plugin-qt

          ./tools/linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --desktop-file AppDir/usr/share/applications/ft2.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/ft2.png \
            --executable AppDir/usr/bin/ft2 \
            --executable AppDir/usr/bin/jt9 \
            --executable AppDir/usr/bin/wsprd \
            --executable AppDir/usr/bin/message_aggregator \
            --plugin qt \
            --output appimage

          APPIMAGE_NAME="decodium3-ft2-${VERSION}-linux-x86_64.AppImage"
          APPIMAGE_SRC="$(find . -maxdepth 1 -name '*.AppImage' ! -name 'linuxdeploy*.AppImage' | head -n1)"
          mv "${APPIMAGE_SRC}" "${APPIMAGE_NAME}"
          sha256sum "${APPIMAGE_NAME}" > "${APPIMAGE_NAME}.sha256.txt"
          ls -lh "${APPIMAGE_NAME}" "${APPIMAGE_NAME}.sha256.txt"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: decodium3-ft2-${{ env.VERSION }}-linux-x86_64
          if-no-files-found: error
          path: |
            decodium3-ft2-${{ env.VERSION }}-linux-x86_64.AppImage
            decodium3-ft2-${{ env.VERSION }}-linux-x86_64.AppImage.sha256.txt

  publish:
    name: Publish AppImage to GitHub release
    needs: [build]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Select version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ "$VERSION" != v* ]]; then
            VERSION="v${VERSION}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Using version: ${VERSION}"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: decodium3-ft2-${{ steps.version.outputs.version }}-linux-x86_64
          path: release-assets

      - name: Validate assets
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ls -lh release-assets
          test -f "release-assets/decodium3-ft2-${VERSION}-linux-x86_64.AppImage"
          test -f "release-assets/decodium3-ft2-${VERSION}-linux-x86_64.AppImage.sha256.txt"

      - name: Publish assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${GITHUB_REPOSITORY}"
          ASSETS=(
            "release-assets/decodium3-ft2-${VERSION}-linux-x86_64.AppImage"
            "release-assets/decodium3-ft2-${VERSION}-linux-x86_64.AppImage.sha256.txt"
          )

          if gh release view "${VERSION}" --repo "${REPO}" >/dev/null 2>&1; then
            gh release upload "${VERSION}" "${ASSETS[@]}" --repo "${REPO}" --clobber
          else
            NOTES_FILE="$(mktemp)"
            {
              echo "# Decodium 3 FT2 ${VERSION} (Linux AppImage)"
              echo
              echo "Linux x86_64 AppImage release for fork ${VERSION}."
              echo
              echo "Includes upstream Raptor feature import and fork UI/runtime fixes from ${VERSION}."
              echo
              echo "Linux minimum requirements:"
              echo "- x86_64 CPU, 4 GB RAM minimum"
              echo "- glibc >= 2.35"
              echo "- libfuse2/FUSE2 + ALSA/PulseAudio/PipeWire"
              echo
              echo "If the macOS app is blocked, run:"
              echo "\`sudo xattr -r -d com.apple.quarantine /Applications/ft2.app\`"
            } > "${NOTES_FILE}"
            gh release create "${VERSION}" "${ASSETS[@]}" \
              --repo "${REPO}" \
              --title "Decodium 3 FT2 ${VERSION}" \
              --notes-file "${NOTES_FILE}"
            rm -f "${NOTES_FILE}"
          fi
